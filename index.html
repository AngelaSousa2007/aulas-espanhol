import React, { useState, useEffect, createContext, useContext } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from 'firebase/auth';
import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection } from 'firebase/firestore';

// Definição das cores vibrantes da identidade visual
const colors = {
  primary: '#E53E3E', // Vermelho vibrante
  secondary: '#3182CE', // Azul acolhedor
  accent: '#F6AD55', // Amarelo vibrante
  background: '#F7FAFC', // Fundo claro
  text: '#2D3748', // Texto escuro
  lightText: '#CBD5E0', // Texto mais claro
};

// Contexto para o Firebase e informações do usuário
const FirebaseContext = createContext(null);

// Dados simulados para cursos
const mockCourses = [
  {
    id: 'basic-a1',
    level: 'Básico A1',
    title: 'Espanhol para Iniciantes: Primeiros Passos',
    description: 'Aprenda saudações, apresentações, números, alfabeto e vocabulário básico para o dia a dia.',
    modules: [
      {
        id: 'module-a1-1',
        title: 'Módulo 1: Saudações e Apresentações',
        lessons: [
          {
            id: 'lesson-a1-1-1',
            title: 'Aula 1: Olá e Adeus!',
            videoUrl: 'https://www.youtube.com/embed/dQw4w9WgXcQ', // Placeholder video
            pdfUrl: 'https://www.africau.edu/images/default/sample.pdf', // Placeholder PDF
            transcript: '¡Hola! ¿Cómo estás? Soy [Nome do Professor]. Bienvenido a tu primera clase de español. Hoy aprenderemos las formas básicas de saludar y despedirnos. Por ejemplo, para decir "Olá", decimos "¡Hola!". Para dizer "Adeus", dizemos "¡Adiós!".',
            exercises: [
              {
                type: 'multiple-choice',
                question: 'Como se diz "Olá" em espanhol?',
                options: ['Adiós', 'Hola', 'Gracias', 'Por favor'],
                answer: 'Hola',
              },
              {
                type: 'fill-in-the-blank',
                question: 'Preencha a lacuna: "____ estás?" (Como você está?)',
                answer: 'Cómo',
              },
            ],
          },
          {
            id: 'lesson-a1-1-2',
            title: 'Aula 2: Quem é Você?',
            videoUrl: 'https://www.youtube.com/embed/dQw4w9WgXcQ', // Placeholder video
            pdfUrl: 'https://www.africau.edu/images/default/sample.pdf', // Placeholder PDF
            transcript: 'Hoy aprenderemos a presentarnos y preguntar por el nombre de alguien. Para preguntar "Qual é o seu nome?", dizemos "¿Cómo te llamas?". Para responder, "Meu nome é...", dizemos "Me llamo...".',
            exercises: [
              {
                type: 'multiple-choice',
                question: 'Como se pergunta "Qual é o seu nome?" em espanhol?',
                options: ['¿Qué hora es?', '¿Cómo te llamas?', '¿Cuánto cuesta?', '¿Dónde está?'],
                answer: '¿Cómo te llamas?',
              },
            ],
          },
        ],
      },
      {
        id: 'module-a1-2',
        title: 'Módulo 2: Números e Cores',
        lessons: [
          {
            id: 'lesson-a1-2-1',
            title: 'Aula 1: Contando em Espanhol',
            videoUrl: 'https://www.youtube.com/embed/dQw4w9WgXcQ', // Placeholder video
            pdfUrl: 'https://www.africau.edu/images/default/sample.pdf', // Placeholder PDF
            transcript: 'Vamos a aprender los números del uno al diez. Uno, dos, tres, cuatro, cinco, seis, siete, ocho, nueve, diez.',
            exercises: [
              {
                type: 'fill-in-the-blank',
                question: 'Qual é o número depois de "uno"?',
                answer: 'dos',
              },
            ],
          },
        ],
      },
    ],
  },
  {
    id: 'basic-a2',
    level: 'Básico A2',
    title: 'Espanhol Básico: Ampliando o Vocabulário',
    description: 'Aprofunde-se em vocabulário do dia a dia, verbos regulares e irregulares, e comece a formar frases mais complexas.',
    modules: [], // Conteúdo a ser expandido
  },
  {
    id: 'intermediate-b1',
    level: 'Intermediário B1',
    title: 'Espanhol Intermediário: Tempos Verbais',
    description: 'Domine os tempos verbais pretérito, imperfeito, futuro e condicional, e aprenda expressões idiomáticas.',
    modules: [], // Conteúdo a ser expandido
  },
];

// Componente de Mensagem/Modal
const MessageModal = ({ message, onClose }) => {
  if (!message) return null;
  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full text-center">
        <p className="text-lg font-semibold text-gray-800 mb-4">{message}</p>
        <button
          onClick={onClose}
          className="bg-secondary text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-300"
        >
          OK
        </button>
      </div>
    </div>
  );
};

// Componente de Navegação
const Navbar = ({ setCurrentView, userId, onLogout }) => {
  return (
    <nav className="bg-primary p-4 shadow-md">
      <div className="container mx-auto flex justify-between items-center flex-wrap">
        <div className="text-white text-2xl font-bold rounded-md px-2 py-1">
          <span onClick={() => setCurrentView('landing')} className="cursor-pointer">
            Aprenda Español Ya!
          </span>
        </div>
        <div className="space-x-4 flex items-center flex-wrap justify-center sm:justify-start">
          <button
            onClick={() => setCurrentView('landing')}
            className="text-white hover:text-accent transition duration-300 rounded-md px-3 py-1"
          >
            Início
          </button>
          {userId ? (
            <>
              <button
                onClick={() => setCurrentView('dashboard')}
                className="text-white hover:text-accent transition duration-300 rounded-md px-3 py-1"
              >
                Dashboard
              </button>
              <button
                onClick={() => setCurrentView('catalog')}
                className="text-white hover:text-accent transition duration-300 rounded-md px-3 py-1"
              >
                Cursos
              </button>
              <button
                onClick={() => setCurrentView('profile')}
                className="text-white hover:text-accent transition duration-300 rounded-md px-3 py-1"
              >
                Perfil
              </button>
              <button
                onClick={onLogout}
                className="bg-accent text-primary px-4 py-2 rounded-md hover:bg-yellow-600 transition duration-300 shadow-md"
              >
                Sair
              </button>
            </>
          ) : (
            <button
              onClick={() => setCurrentView('auth')}
              className="bg-accent text-primary px-4 py-2 rounded-md hover:bg-yellow-600 transition duration-300 shadow-md"
            >
              Login/Cadastro
            </button>
          )}
          <button
            onClick={() => setCurrentView('contact')}
            className="text-white hover:text-accent transition duration-300 rounded-md px-3 py-1"
          >
            Contato
          </button>
        </div>
      </div>
    </nav>
  );
};

// Componente da Landing Page
const LandingPage = ({ setCurrentView }) => {
  return (
    <div className="min-h-screen bg-background flex flex-col items-center justify-center p-6 text-center">
      <div className="bg-white p-8 rounded-lg shadow-xl max-w-4xl w-full">
        <h1 className="text-5xl font-extrabold text-primary mb-4 animate-fade-in-down">
          Aprenda Español Ya!
        </h1>
        <p className="text-xl text-text mb-8">
          Seu portal gratuito para o mundo hispânico.
        </p>
        <p className="text-lg text-gray-700 mb-8 max-w-2xl mx-auto">
          Democratize o acesso ao ensino de espanhol de qualidade, oferecendo um ambiente de aprendizagem interativo e completo, totalmente gratuito, para falantes de português. Torne-se parte da nossa comunidade e comece a falar espanhol hoje!
        </p>
        <button
          onClick={() => setCurrentView('catalog')}
          className="bg-secondary text-white px-8 py-4 text-xl font-bold rounded-full hover:bg-blue-700 transition duration-300 transform hover:scale-105 shadow-lg"
        >
          Comece a Aprender Espanhol Agora!
        </button>

        <div className="mt-12">
          <h2 className="text-3xl font-bold text-primary mb-6">Nossa Metodologia</h2>
          <div className="grid md:grid-cols-3 gap-8">
            <div className="p-6 bg-gray-100 rounded-lg shadow-md">
              <h3 className="text-xl font-semibold text-text mb-2">Abordagem Comunicativa</h3>
              <p className="text-gray-600">Foco em situações reais de uso da língua para uma aprendizagem prática e eficaz.</p>
            </div>
            <div className="p-6 bg-gray-100 rounded-lg shadow-md">
              <h3 className="text-xl font-semibold text-text mb-2">Aprendizagem por Projetos</h3>
              <p className="text-gray-600">Pequenos projetos que simulam situações do dia a dia para fixar o conhecimento.</p>
            </div>
            <div className="p-6 bg-gray-100 rounded-lg shadow-md">
              <h3 className="text-xl font-semibold text-text mb-2">Imersão Gradual</h3>
              <p className="text-gray-600">Exposição a materiais autênticos desde o início, com suporte e orientação.</p>
            </div>
          </div>
        </div>

        <div className="mt-12 text-gray-600">
          <p>Siga-nos nas redes sociais:</p>
          <div className="flex justify-center space-x-6 mt-4">
            <a href="https://facebook.com" target="_blank" rel="noopener noreferrer" className="text-secondary hover:text-blue-700 transition duration-300">
              <i className="fab fa-facebook-f text-3xl"></i>
            </a>
            <a href="https://instagram.com" target="_blank" rel="noopener noreferrer" className="text-secondary hover:text-blue-700 transition duration-300">
              <i className="fab fa-instagram text-3xl"></i>
            </a>
            <a href="https://youtube.com" target="_blank" rel="noopener noreferrer" className="text-secondary hover:text-blue-700 transition duration-300">
              <i className="fab fa-youtube text-3xl"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  );
};

// Componente de Autenticação (Login/Cadastro Simplificado)
const AuthPage = ({ setCurrentView }) => {
  const { auth, db, userId, setUserId, setUserProfile } = useContext(FirebaseContext);
  const [email, setEmail] = useState('');
  const [name, setName] = useState('');
  const [password, setPassword] = useState('');
  const [isRegister, setIsRegister] = useState(false);
  const [message, setMessage] = useState('');

  const handleAuth = async () => {
    setMessage('');
    try {
      if (isRegister) {
        // Simula o registro, na prática, signInAnonymously ou custom token já autentica
        // Para um registro real, seria necessário um backend para criar usuários
        await signInAnonymously(auth);
        const currentUserId = auth.currentUser?.uid || crypto.randomUUID();
        setUserId(currentUserId);
        const userRef = doc(db, `artifacts/${__app_id}/users/${currentUserId}/profile/data`);
        await setDoc(userRef, {
          name: name,
          email: email,
          enrolledCourses: [],
          progress: {},
          lastLogin: new Date().toISOString(),
        }, { merge: true });
        setUserProfile({ name, email, enrolledCourses: [], progress: {} });
        setMessage('Cadastro realizado com sucesso! Bem-vindo(a)!');
        setCurrentView('dashboard');
      } else {
        await signInAnonymously(auth); // Apenas um exemplo, na prática seria login com email/senha
        const currentUserId = auth.currentUser?.uid || crypto.randomUUID();
        setUserId(currentUserId);
        // Tenta buscar o perfil do usuário existente
        const userRef = doc(db, `artifacts/${__app_id}/users/${currentUserId}/profile/data`);
        const docSnap = await getDoc(userRef);
        if (docSnap.exists()) {
          setUserProfile(docSnap.data());
          setMessage('Login realizado com sucesso!');
        } else {
          // Se não houver perfil, cria um básico para o usuário anônimo
          await setDoc(userRef, {
            name: 'Usuário Anônimo', // Default name
            email: 'anonimo@email.com', // Default email
            enrolledCourses: [],
            progress: {},
            lastLogin: new Date().toISOString(),
          }, { merge: true });
          setUserProfile({ name: 'Usuário Anônimo', email: 'anonimo@email.com', enrolledCourses: [], progress: {} });
          setMessage('Login anônimo realizado. Crie um perfil para salvar seu progresso!');
        }
        setCurrentView('dashboard');
      }
    } catch (error) {
      console.error("Erro durante autenticação:", error);
      setMessage(`Erro: ${error.message}`);
    }
  };

  return (
    <div className="min-h-screen bg-background flex flex-col items-center justify-center p-6">
      <div className="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
        <h2 className="text-3xl font-bold text-primary mb-6 text-center">
          {isRegister ? 'Crie Sua Conta' : 'Entre na Sua Conta'}
        </h2>
        {isRegister && (
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="name">
              Nome
            </label>
            <input
              type="text"
              id="name"
              className="shadow appearance-none border rounded-md w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-secondary transition duration-300"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="Seu nome"
            />
          </div>
        )}
        <div className="mb-4">
          <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="email">
            Email
          </label>
          <input
            type="email"
            id="email"
            className="shadow appearance-none border rounded-md w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-secondary transition duration-300"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="seu@email.com"
          />
        </div>
        <div className="mb-6">
          <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">
            Senha
          </label>
          <input
            type="password"
            id="password"
            className="shadow appearance-none border rounded-md w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline focus:border-secondary transition duration-300"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            placeholder="********"
          />
        </div>
        <button
          onClick={handleAuth}
          className="bg-primary text-white font-bold py-3 px-6 rounded-md w-full hover:bg-red-700 transition duration-300 shadow-lg transform hover:scale-105"
        >
          {isRegister ? 'Cadastrar' : 'Entrar'}
        </button>
        <p className="text-center text-gray-600 text-sm mt-6">
          {isRegister ? 'Já tem uma conta?' : 'Não tem uma conta?'}
          <button
            onClick={() => setIsRegister(!isRegister)}
            className="text-secondary ml-2 font-bold hover:underline transition duration-300"
          >
            {isRegister ? 'Login' : 'Cadastre-se'}
          </button>
        </p>
        <MessageModal message={message} onClose={() => setMessage('')} />
      </div>
    </div>
  );
};

// Componente do Dashboard
const Dashboard = ({ setCurrentView, userId, userProfile }) => {
  if (!userProfile) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center text-text p-6">
        Carregando perfil do usuário...
      </div>
    );
  }

  const enrolledCourses = userProfile.enrolledCourses || [];

  return (
    <div className="min-h-screen bg-background p-6">
      <div className="container mx-auto bg-white p-8 rounded-lg shadow-xl">
        <h2 className="text-4xl font-bold text-primary mb-6">
          Bem-vindo(a), {userProfile.name || 'Aluno(a)'}!
        </h2>
        <p className="text-gray-600 mb-4">Seu ID de Usuário: <span className="font-mono bg-gray-100 p-1 rounded-md">{userId}</span></p>

        <h3 className="text-2xl font-bold text-text mb-4">Seus Cursos Matriculados</h3>
        {enrolledCourses.length > 0 ? (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {enrolledCourses.map((courseId) => {
              const course = mockCourses.find((c) => c.id === courseId);
              if (!course) return null; // Caso o curso não seja encontrado
              return (
                <div key={course.id} className="bg-gray-50 p-6 rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition duration-300">
                  <h4 className="text-xl font-semibold text-secondary mb-2">{course.title}</h4>
                  <p className="text-gray-700 mb-4">{course.description}</p>
                  <p className="text-sm text-gray-500 mb-4">Nível: {course.level}</p>
                  <button
                    onClick={() => setCurrentView('course', { courseId: course.id })}
                    className="bg-primary text-white px-5 py-2 rounded-md hover:bg-red-700 transition duration-300 shadow-md"
                  >
                    Continuar Aprendendo
                  </button>
                </div>
              );
            })}
          </div>
        ) : (
          <div className="bg-blue-50 border-l-4 border-secondary text-blue-700 p-4 rounded-md" role="alert">
            <p className="font-bold mb-2">Nenhum curso matriculado ainda!</p>
            <p>Visite o <button onClick={() => setCurrentView('catalog')} className="font-semibold underline text-secondary hover:text-blue-800">Catálogo de Cursos</button> para começar a aprender.</p>
          </div>
        )}

        <h3 className="text-2xl font-bold text-text mb-4 mt-8">Progresso Geral</h3>
        <div className="bg-green-50 border-l-4 border-green-500 text-green-700 p-4 rounded-md" role="alert">
            <p className="font-bold">Em Construção!</p>
            <p>Esta seção mostrará seu progresso em todas as aulas em breve.</p>
        </div>
      </div>
    </div>
  );
};

// Componente do Catálogo de Cursos
const CourseCatalog = ({ setCurrentView, userProfile, setUserProfile }) => {
  const { db, auth, userId } = useContext(FirebaseContext);
  const [message, setMessage] = useState('');

  const handleEnroll = async (courseId) => {
    if (!userId) {
      setMessage('Você precisa estar logado para se matricular em um curso.');
      return;
    }
    if (userProfile.enrolledCourses.includes(courseId)) {
      setMessage('Você já está matriculado neste curso!');
      return;
    }
    try {
      const userRef = doc(db, `artifacts/${__app_id}/users/${userId}/profile/data`);
      const updatedEnrolledCourses = [...userProfile.enrolledCourses, courseId];
      await setDoc(userRef, { enrolledCourses: updatedEnrolledCourses }, { merge: true });
      setUserProfile({ ...userProfile, enrolledCourses: updatedEnrolledCourses });
      setMessage('Matrícula realizada com sucesso!');
    } catch (error) {
      console.error('Erro ao matricular no curso:', error);
      setMessage('Erro ao matricular no curso. Tente novamente.');
    }
  };

  return (
    <div className="min-h-screen bg-background p-6">
      <div className="container mx-auto bg-white p-8 rounded-lg shadow-xl">
        <h2 className="text-4xl font-bold text-primary mb-6 text-center">Catálogo de Cursos</h2>
        <p className="text-lg text-gray-700 mb-8 text-center">
          Explore nossos cursos gratuitos de espanhol e comece sua jornada de aprendizado!
        </p>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {mockCourses.map((course) => (
            <div key={course.id} className="bg-gray-50 p-6 rounded-lg shadow-md border border-gray-200 flex flex-col justify-between hover:shadow-lg transition duration-300">
              <div>
                <span className="inline-block bg-accent text-primary text-xs font-semibold px-3 py-1 rounded-full mb-2">
                  {course.level}
                </span>
                <h3 className="text-2xl font-bold text-secondary mb-3">{course.title}</h3>
                <p className="text-gray-700 mb-4">{course.description}</p>
              </div>
              <div className="mt-4 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                <button
                  onClick={() => setCurrentView('course', { courseId: course.id })}
                  className="bg-primary text-white px-6 py-3 rounded-md hover:bg-red-700 transition duration-300 shadow-md flex-grow"
                >
                  Ver Curso
                </button>
                {userProfile && !userProfile.enrolledCourses.includes(course.id) && (
                  <button
                    onClick={() => handleEnroll(course.id)}
                    className="bg-accent text-primary px-6 py-3 rounded-md hover:bg-yellow-600 transition duration-300 shadow-md flex-grow"
                  >
                    Matricular-se
                  </button>
                )}
                {userProfile && userProfile.enrolledCourses.includes(course.id) && (
                  <span className="text-green-600 font-semibold py-3 px-6 text-center border border-green-400 rounded-md bg-green-50">
                    Matriculado!
                  </span>
                )}
              </div>
            </div>
          ))}
        </div>
        <MessageModal message={message} onClose={() => setMessage('')} />
      </div>
    </div>
  );
};

// Componente da Página de Aula
const CoursePage = ({ courseId, setCurrentView, userId, userProfile, setUserProfile }) => {
  const { db } = useContext(FirebaseContext);
  const course = mockCourses.find((c) => c.id === courseId);
  const [selectedLesson, setSelectedLesson] = useState(null);
  const [message, setMessage] = useState('');
  const [exerciseAnswers, setExerciseAnswers] = useState({});
  const [exerciseFeedback, setExerciseFeedback] = useState({});

  useEffect(() => {
    if (course && course.modules.length > 0 && course.modules[0].lessons.length > 0) {
      setSelectedLesson(course.modules[0].lessons[0]); // Seleciona a primeira aula por padrão
    }
  }, [course]);

  const handleExerciseChange = (exerciseId, value) => {
    setExerciseAnswers(prev => ({ ...prev, [exerciseId]: value }));
    setExerciseFeedback(prev => ({ ...prev, [exerciseId]: '' })); // Limpa feedback ao mudar resposta
  };

  const checkExercise = (exercise) => {
    const userAnswer = exerciseAnswers[exercise.id];
    if (userAnswer === undefined || userAnswer.trim() === '') {
      setMessage('Por favor, responda o exercício antes de verificar.');
      return;
    }
    const isCorrect = userAnswer.toLowerCase() === exercise.answer.toLowerCase();
    setExerciseFeedback(prev => ({ ...prev, [exercise.id]: isCorrect ? 'Correto!' : `Incorreto. A resposta é "${exercise.answer}".` }));
    setMessage(isCorrect ? 'Resposta Correta!' : 'Resposta Incorreta.');

    // Atualizar progresso do usuário no Firestore (simples, marca aula como completa)
    if (userId && isCorrect) {
        updateUserProgress(exercise.id, true);
    }
  };

  const updateUserProgress = async (lessonId, isCompleted) => {
    if (!userId || !userProfile) return;
    try {
      const userRef = doc(db, `artifacts/${__app_id}/users/${userId}/profile/data`);
      const newProgress = { ...userProfile.progress, [lessonId]: isCompleted };
      await setDoc(userRef, { progress: newProgress }, { merge: true });
      setUserProfile({ ...userProfile, progress: newProgress });
      // console.log(`Progresso da aula ${lessonId} atualizado para ${isCompleted}`);
    } catch (error) {
      console.error("Erro ao atualizar progresso:", error);
    }
  };

  if (!course) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center text-text p-6">
        Curso não encontrado.
        <button onClick={() => setCurrentView('catalog')} className="ml-4 bg-primary text-white px-4 py-2 rounded-md hover:bg-red-700">Voltar ao Catálogo</button>
      </div>
    );
  }

  const isLessonCompleted = (lessonId) => {
    return userProfile?.progress?.[lessonId] === true;
  };

  return (
    <div className="min-h-screen bg-background p-6 flex">
      {/* Sidebar de Módulos e Aulas */}
      <div className="w-1/4 bg-white p-6 rounded-lg shadow-xl mr-6 overflow-y-auto max-h-[calc(100vh-64px)] hidden md:block">
        <h3 className="text-2xl font-bold text-secondary mb-4">{course.title}</h3>
        {course.modules.map((module) => (
          <div key={module.id} className="mb-4">
            <h4 className="text-xl font-semibold text-text mb-2">{module.title}</h4>
            <ul>
              {module.lessons.map((lesson) => (
                <li key={lesson.id} className="mb-1">
                  <button
                    onClick={() => {
                      setSelectedLesson(lesson);
                      setExerciseAnswers({}); // Reset answers when changing lesson
                      setExerciseFeedback({}); // Reset feedback
                      setMessage('');
                    }}
                    className={`block w-full text-left p-2 rounded-md ${
                      selectedLesson?.id === lesson.id
                        ? 'bg-secondary text-white'
                        : 'text-gray-700 hover:bg-gray-100'
                    } transition duration-200 relative`}
                  >
                    {lesson.title}
                    {isLessonCompleted(lesson.id) && (
                      <span className="absolute right-2 top-1/2 -translate-y-1/2 text-green-500">
                         <i className="fas fa-check-circle"></i>
                      </span>
                    )}
                  </button>
                </li>
              ))}
            </ul>
          </div>
        ))}
      </div>

      {/* Conteúdo da Aula */}
      <div className="flex-1 bg-white p-8 rounded-lg shadow-xl overflow-y-auto max-h-[calc(100vh-64px)]">
        <button
          onClick={() => setCurrentView('catalog')}
          className="mb-6 bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition duration-300"
        >
          &larr; Voltar ao Catálogo
        </button>
        {selectedLesson ? (
          <>
            <h2 className="text-3xl font-bold text-primary mb-4">{selectedLesson.title}</h2>
            <div className="aspect-video w-full mb-6 rounded-lg overflow-hidden shadow-lg">
              <iframe
                width="100%"
                height="100%"
                src={selectedLesson.videoUrl}
                title={selectedLesson.title}
                frameBorder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowFullScreen
              ></iframe>
            </div>

            <h3 className="text-2xl font-bold text-text mb-3">Transcrição</h3>
            <p className="text-gray-700 mb-6 bg-gray-50 p-4 rounded-md border border-gray-100">
              {selectedLesson.transcript}
            </p>

            <h3 className="text-2xl font-bold text-text mb-3">Material Complementar</h3>
            <a
              href={selectedLesson.pdfUrl}
              target="_blank"
              rel="noopener noreferrer"
              className="inline-block bg-secondary text-white px-6 py-3 rounded-md hover:bg-blue-700 transition duration-300 shadow-md mb-6"
            >
              <i className="fas fa-file-pdf mr-2"></i> Baixar PDF da Aula
            </a>

            <h3 className="text-2xl font-bold text-text mb-4">Exercícios</h3>
            {selectedLesson.exercises && selectedLesson.exercises.length > 0 ? (
              <div className="space-y-6">
                {selectedLesson.exercises.map((exercise, index) => (
                  <div key={exercise.id || index} className="bg-gray-50 p-6 rounded-lg shadow-md border border-gray-100">
                    <p className="text-lg font-semibold text-gray-800 mb-3">{exercise.question}</p>
                    {exercise.type === 'multiple-choice' && (
                      <div className="space-y-2">
                        {exercise.options.map((option, optIndex) => (
                          <label key={optIndex} className="flex items-center text-gray-700 cursor-pointer">
                            <input
                              type="radio"
                              name={`exercise-${exercise.id}`}
                              value={option}
                              checked={exerciseAnswers[exercise.id] === option}
                              onChange={(e) => handleExerciseChange(exercise.id, e.target.value)}
                              className="form-radio h-5 w-5 text-secondary"
                            />
                            <span className="ml-2">{option}</span>
                          </label>
                        ))}
                      </div>
                    )}
                    {exercise.type === 'fill-in-the-blank' && (
                      <input
                        type="text"
                        className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-secondary transition duration-300"
                        value={exerciseAnswers[exercise.id] || ''}
                        onChange={(e) => handleExerciseChange(exercise.id, e.target.value)}
                        placeholder="Sua resposta"
                      />
                    )}
                    <button
                      onClick={() => checkExercise(exercise)}
                      className="mt-4 bg-primary text-white px-5 py-2 rounded-md hover:bg-red-700 transition duration-300 shadow-sm"
                    >
                      Verificar Resposta
                    </button>
                    {exerciseFeedback[exercise.id] && (
                      <p className={`mt-3 font-semibold ${exerciseFeedback[exercise.id].includes('Correto') ? 'text-green-600' : 'text-red-600'}`}>
                        {exerciseFeedback[exercise.id]}
                      </p>
                    )}
                  </div>
                ))}
              </div>
            ) : (
              <p className="text-gray-600">Nenhum exercício disponível para esta aula.</p>
            )}
            <MessageModal message={message} onClose={() => setMessage('')} />

            <div className="mt-8">
              <h3 className="text-2xl font-bold text-text mb-4">Fórum de Perguntas e Respostas</h3>
              <div className="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md mb-6" role="alert">
                  <p className="font-bold">Em Construção!</p>
                  <p>A seção de fórum e campo de notas será implementada em breve.</p>
              </div>

              <h3 className="text-2xl font-bold text-text mb-4">Campo de Notas</h3>
              <textarea
                className="w-full p-4 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-secondary transition duration-300"
                rows="5"
                placeholder="Anote aqui seus pensamentos e dúvidas sobre a aula..."
              ></textarea>
            </div>
          </>
        ) : (
          <div className="text-center py-10 text-gray-600">
            <h3 className="text-2xl font-semibold mb-4">Selecione uma aula para começar.</h3>
            <p>Use a barra lateral para navegar pelos módulos e aulas.</p>
          </div>
        )}
      </div>
    </div>
  );
};

// Componente do Perfil do Usuário
const ProfilePage = ({ userId, userProfile, setCurrentView }) => {
  if (!userProfile) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center text-text p-6">
        Carregando perfil...
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background flex flex-col items-center p-6">
      <div className="bg-white p-8 rounded-lg shadow-xl max-w-2xl w-full">
        <h2 className="text-4xl font-bold text-primary mb-6 text-center">Meu Perfil</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div className="bg-gray-50 p-4 rounded-md shadow-sm">
            <p className="text-gray-600 text-sm">Nome:</p>
            <p className="text-xl font-semibold text-text">{userProfile.name || 'Não definido'}</p>
          </div>
          <div className="bg-gray-50 p-4 rounded-md shadow-sm">
            <p className="text-gray-600 text-sm">Email:</p>
            <p className="text-xl font-semibold text-text">{userProfile.email || 'Não definido'}</p>
          </div>
        </div>
        <div className="bg-gray-50 p-4 rounded-md shadow-sm mb-6">
          <p className="text-gray-600 text-sm">Seu ID de Usuário:</p>
          <p className="text-lg font-mono bg-gray-100 p-1 rounded-md inline-block text-text">{userId}</p>
        </div>

        <h3 className="text-2xl font-bold text-text mb-4">Progresso Detalhado</h3>
        <div className="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md" role="alert">
            <p className="font-bold">Em Construção!</p>
            <p>Esta seção mostrará seu progresso detalhado em todas as aulas em breve.</p>
        </div>

        <button
          onClick={() => setCurrentView('dashboard')}
          className="mt-8 bg-secondary text-white px-6 py-3 rounded-md hover:bg-blue-700 transition duration-300 shadow-lg w-full"
        >
          Voltar ao Dashboard
        </button>
      </div>
    </div>
  );
};

// Componente de Contato e FAQ
const ContactPage = () => {
  const [message, setMessage] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    setMessage('Sua mensagem foi enviada! Entraremos em contato em breve.');
    // Lógica para enviar o formulário (e.g., via API)
  };

  return (
    <div className="min-h-screen bg-background p-6 flex flex-col items-center">
      <div className="bg-white p-8 rounded-lg shadow-xl max-w-4xl w-full">
        <h2 className="text-4xl font-bold text-primary mb-6 text-center">Contato e FAQ</h2>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
          {/* Formulário de Contato */}
          <div>
            <h3 className="text-2xl font-bold text-text mb-4">Envie-nos uma Mensagem</h3>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="contact-name">
                  Nome
                </label>
                <input
                  type="text"
                  id="contact-name"
                  className="shadow appearance-none border rounded-md w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-secondary transition duration-300"
                  placeholder="Seu nome"
                  required
                />
              </div>
              <div>
                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="contact-email">
                  Email
                </label>
                <input
                  type="email"
                  id="contact-email"
                  className="shadow appearance-none border rounded-md w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-secondary transition duration-300"
                  placeholder="seu@email.com"
                  required
                />
              </div>
              <div>
                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="contact-message">
                  Mensagem
                </label>
                <textarea
                  id="contact-message"
                  className="shadow appearance-none border rounded-md w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-secondary transition duration-300"
                  rows="5"
                  placeholder="Sua mensagem..."
                  required
                ></textarea>
              </div>
              <button
                type="submit"
                className="bg-primary text-white font-bold py-3 px-6 rounded-md hover:bg-red-700 transition duration-300 shadow-lg"
              >
                Enviar Mensagem
              </button>
            </form>
            <MessageModal message={message} onClose={() => setMessage('')} />
          </div>

          {/* FAQ */}
          <div>
            <h3 className="text-2xl font-bold text-text mb-4">Perguntas Frequentes (FAQ)</h3>
            <div className="space-y-4">
              <div className="bg-gray-50 p-4 rounded-md shadow-sm">
                <h4 className="text-lg font-semibold text-text mb-1">A plataforma é realmente gratuita?</h4>
                <p className="text-gray-700">Sim, todo o conteúdo principal da plataforma "Aprenda Español Ya!" é 100% gratuito e sempre será.</p>
              </div>
              <div className="bg-gray-50 p-4 rounded-md shadow-sm">
                <h4 className="text-lg font-semibold text-text mb-1">Como posso apoiar o projeto?</h4>
                <p className="text-gray-700">Você pode nos apoiar através de doações, voluntariado ou divulgando a plataforma para amigos e familiares!</p>
              </div>
              <div className="bg-gray-50 p-4 rounded-md shadow-sm">
                <h4 className="text-lg font-semibold text-text mb-1">Posso obter um certificado?</h4>
                <p className="text-gray-700">Atualmente, oferecemos badges de conclusão. Certificados formais podem ser uma funcionalidade futura.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// Main App Component
const App = () => {
  const [currentView, setCurrentView] = useState('landing'); // 'landing', 'auth', 'dashboard', 'catalog', 'course', 'profile', 'contact'
  const [selectedCourseId, setSelectedCourseId] = useState(null); // Para a página de curso
  const [firebaseApp, setFirebaseApp] = useState(null);
  const [auth, setAuth] = useState(null);
  const [db, setDb] = useState(null);
  const [userId, setUserId] = useState(null);
  const [userProfile, setUserProfile] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [message, setMessage] = useState('');

  // Função para navegar entre as views e passar dados adicionais
  const handleSetCurrentView = (view, params = {}) => {
    setCurrentView(view);
    if (view === 'course' && params.courseId) {
      setSelectedCourseId(params.courseId);
    } else {
      setSelectedCourseId(null);
    }
  };

  // Inicialização do Firebase e autenticação
  useEffect(() => {
    try {
      const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
      const app = initializeApp(firebaseConfig);
      const authInstance = getAuth(app);
      const dbInstance = getFirestore(app);

      setFirebaseApp(app);
      setAuth(authInstance);
      setDb(dbInstance);

      const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
        if (user) {
          const currentUserId = user.uid;
          setUserId(currentUserId);

          const userRef = doc(dbInstance, `artifacts/${__app_id}/users/${currentUserId}/profile/data`);
          const userDoc = await getDoc(userRef);

          if (userDoc.exists()) {
            setUserProfile(userDoc.data());
          } else {
            // Se o usuário autenticado não tiver um perfil, cria um básico
            await setDoc(userRef, {
              name: user.isAnonymous ? 'Usuário Anônimo' : user.email?.split('@')[0] || 'Novo Aluno',
              email: user.isAnonymous ? 'anonimo@example.com' : user.email || 'email@example.com',
              enrolledCourses: [],
              progress: {},
              createdAt: new Date().toISOString(),
            }, { merge: true });
            setUserProfile({
              name: user.isAnonymous ? 'Usuário Anônimo' : user.email?.split('@')[0] || 'Novo Aluno',
              email: user.isAnonymous ? 'anonimo@example.com' : user.email || 'email@example.com',
              enrolledCourses: [],
              progress: {},
            });
          }
        } else {
          setUserId(null);
          setUserProfile(null);
          // console.log("Nenhum usuário logado. Tentando login anônimo...");
          // Tenta fazer login anônimo se não houver token inicial
          const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
          if (initialAuthToken) {
            try {
              await signInWithCustomToken(authInstance, initialAuthToken);
            } catch (error) {
              console.error("Erro ao fazer login com token customizado:", error);
              // Fallback para login anônimo se o token falhar
              try {
                await signInAnonymously(authInstance);
                // console.log("Login anônimo realizado com sucesso.");
              } catch (anonError) {
                console.error("Erro ao fazer login anônimo:", anonError);
                setMessage("Falha ao inicializar o usuário. Recarregue a página.");
              }
            }
          } else {
            try {
              await signInAnonymously(authInstance);
              // console.log("Login anônimo realizado com sucesso.");
            } catch (anonError) {
              console.error("Erro ao fazer login anônimo:", anonError);
              setMessage("Falha ao inicializar o usuário. Recarregue a página.");
            }
          }
        }
        setIsAuthReady(true);
      });

      return () => unsubscribe();
    } catch (e) {
      console.error("Erro na inicialização do Firebase:", e);
      setMessage(`Erro crítico na inicialização: ${e.message}`);
    }
  }, []);

  // Listener para atualizações do perfil do usuário em tempo real
  useEffect(() => {
    if (db && userId && isAuthReady) {
      const userRef = doc(db, `artifacts/${__app_id}/users/${userId}/profile/data`);
      const unsubscribe = onSnapshot(userRef, (docSnap) => {
        if (docSnap.exists()) {
          setUserProfile(docSnap.data());
        } else {
          // Se o documento não existe mais, pode ser que o usuário foi removido ou resetado
          setUserProfile(null);
          // Opcional: redirecionar para a página de login
          // setCurrentView('auth');
        }
      }, (error) => {
        console.error("Erro ao receber updates do perfil:", error);
        setMessage("Erro ao carregar dados do perfil. Tente novamente.");
      });
      return () => unsubscribe();
    }
  }, [db, userId, isAuthReady]);

  const handleLogout = async () => {
    if (auth) {
      try {
        await signOut(auth);
        setUserId(null);
        setUserProfile(null);
        setCurrentView('landing');
        setMessage('Você saiu da sua conta.');
      } catch (error) {
        console.error('Erro ao fazer logout:', error);
        setMessage('Erro ao fazer logout. Tente novamente.');
      }
    }
  };

  const renderView = () => {
    if (!isAuthReady) {
      return (
        <div className="min-h-screen bg-background flex items-center justify-center text-text text-xl font-semibold">
          Carregando plataforma...
          <MessageModal message={message} onClose={() => setMessage('')} />
        </div>
      );
    }

    switch (currentView) {
      case 'landing':
        return <LandingPage setCurrentView={handleSetCurrentView} />;
      case 'auth':
        return <AuthPage setCurrentView={handleSetCurrentView} />;
      case 'dashboard':
        return <Dashboard setCurrentView={handleSetCurrentView} userId={userId} userProfile={userProfile} />;
      case 'catalog':
        return <CourseCatalog setCurrentView={handleSetCurrentView} userProfile={userProfile} setUserProfile={setUserProfile} />;
      case 'course':
        return <CoursePage courseId={selectedCourseId} setCurrentView={handleSetCurrentView} userId={userId} userProfile={userProfile} setUserProfile={setUserProfile} />;
      case 'profile':
        return <ProfilePage userId={userId} userProfile={userProfile} setCurrentView={handleSetCurrentView} />;
      case 'contact':
        return <ContactPage />;
      default:
        return <LandingPage setCurrentView={handleSetCurrentView} />;
    }
  };

  return (
    <FirebaseContext.Provider value={{ firebaseApp, auth, db, userId, setUserId, userProfile, setUserProfile, isAuthReady }}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .animate-fade-in-down {
          animation: fadeInDown 1s ease-out;
        }
        @keyframes fadeInDown {
          from { opacity: 0; transform: translateY(-20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        /* Font Awesome for icons */
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css');
      `}</style>
      <Navbar setCurrentView={handleSetCurrentView} userId={userId} onLogout={handleLogout} />
      {renderView()}
    </FirebaseContext.Provider>
  );
};

export default App;
